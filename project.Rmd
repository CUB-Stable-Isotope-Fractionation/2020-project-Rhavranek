---
title: "Soil Water Evaporation"
author: "Rachel Havranek"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output:
  html_document: 
    df_print: paged
    toc: yes
    234toc_depth: 2
    toc_float: true
    code_folding: show
---


```{r "load packages", include=FALSE, message=FALSE}
library(tidyverse)
```




# Saturated Soil 
### After Zimmermann et al., 1967:
This is a soil where the water content (theta) is 1.  
$$
\frac{dR}{dz} = \frac{E(R-R_{res})}{D^*} \\
where:\\
D^* = \text{effective diffusivity of the isotope in the pore water} (p\tau D_l)\\
and\\
p = total\ porosity\ \\
\tau = tortuosity \\
D_l = diffusion\ coefficient\ of\ liquid\ water\ [m^2/sec]
$$

where D star is diffusivity of the isotope in pore water, E is evaporation rate, R_res is the isotope ratio of water entering the column from below

for D_l go see Mills and Harris, 1976\\

The solution of the differenential equation above is:
$$
R = R_{res} + (R_0 - R_{res})*e^{(-zE/D^*)} \\
$$

*This assumes that pore space is constant through the soil column.*

In delta notatino we get: 

$$
\delta  = \delta_{res} +(\delta_{surface} - \delta_{res})*e^{(-z/z_l)} \\
z_l = D^*/E
$$

Activity 1: In breakout rooms, describe in words what's going on in this equation (pairs). Can you relate that back to the craig-gordon model of evaporation?


```{r}
saturated_soil <- tibble(
  # set up 
  z = seq(0,1, by = .001), #m
  
  #Oxygen isotope boundary conditions
  d18O_res = -4, #permil
  d18O_surface = 0, #permil
  
  #Soil boundary conditions
  E = 10E-9, #m/sec - this is just under 1 mm / day (0.864 mm/ day)
  p = 0.3, # porosity, unitless
  tau = 0.67, #toruosity, unitless
  theta = 0.3, #volumetric water content unitless
  D = 1.5E-9, #m^2 / sec from Barnes and Allison, 1988
  f = tau*theta,

  
  #calculated terms
  D_star = f*D,  #m^2 / sec
  z_l = D_star/E, #m
  d18O_z = d18O_res + (d18O_surface - d18O_res)*exp(-z/z_l) #permil
)

saturated_soil %>% ggplot()+aes(x = d18O_z, y = z) + geom_line()  + scale_y_reverse(limits = c(0.25, 0)) + scale_x_continuous(limits = c(-4,0))
```
Question: Picarro water isotope analyzers (like those you might find in IsoLab in SEEC) have a precision of usually +/- 0.25 permil in oxygen isotope space. To what depth would you be able to differentiate water that has been partially evaporated from the rest of the soil water? 


# Unsaturated Soil:

## Water concentration curve:
Let's inspect a soil, with a water concentration profile that looks like this: 
```{r inset}
water_C <- tibble (
  z = seq (0,1, by = 0.001),
  theta = ifelse(z<=0.05, 0.05, (z+0.9)/19)
)
  
water_C %>% ggplot () + aes(x = theta, y = z) %>% geom_line()+scale_y_reverse()+scale_x_continuous(limits = c(0,.1))
```



## vapor transport region: 
The relative humidity above the evaporitng front in the soil varies linearly with depth (eq 9:
$$
\frac {dN}{dz} = \frac{\rho E}{D^*_{vapor}} \\
where: \\
\text {N = concentration of water vapor in the soil}\\
\text {rho = density of liquid water}\\

$$

Equation 10:
$$
D^*_{vapor} = \text{effective diffusivity of water vapor}\\
D^*_{vapor} = \tau*D^v(\rho-\theta)
$$
theta is the water filled porosity 
so (subbing 9 into 10) .... 
$$
\frac {dN}{dz} = \frac{\rho E}{\tau*D^v(\rho-\theta)}
$$




equations 11 & 12:
$$
h = h_a + z/z_{penetration}\\
z_{penetration} = \frac{N_{saturation}D^*_{vapor}}{\rho E}
$$
Equation 13:
$$
z_{penetration} = \text{penetration depth}\\
z_{ef} = \text{depth of evaporating front}\\
\text{these are related by the equation:}\\
z_{ef} = (h_{ef} - h_{surface})*z_{penetration}
$$


Equation 17: 
$$
\alpha_{eq}hR_l = \sigma_i*R_{reservoir}*z/z_{penetration} + h_aR^a
$$

Equation 18 (uses the assumption epsilon = 1 - alpha:
$$
\delta = \frac{\delta^a +\epsilon_{eq} +(\eta(1+\delta_{reservoir}) + (\delta_{reservoir} - \delta^a)) (z/(z+h_a z_{penetration} ))} {\alpha_{eq}}
$$
hoooo! That's a lot to look at, let's break that up:\\

1. a description of how the 'reservoir' and air diffuse:remember, } 
$\eta_i$ = a measure of the ability of molection of species i to escape from the surface
$$
diff = \eta(1+\delta_{reservoir}) + (\delta_{reservoir} - \delta^a)
$$
so, the equation breaks up into, how effective are molevules of species i leaving the reservoir, and how differeent are the reservoir and air 


1. a description of what the humidity is at every z:
$$
humidity = (z/(z+h_a z_{penetration} ))
$$
So, the equation above can be rewritten as: 
$$
\delta = \frac{\delta^a +\epsilon_{eq} +(diffusion)*(humidity)} {\alpha_{eq}}
$$

```{r frationation factor}
temp.K = 293.15



```






```{r}
vt_region <-  tibble(
  #the basics: 
  z = seq(0,.1, by = .001), #m
  temp = 20, #°C
  temp.K = temp + 273.15,
  rho = 997, #kg/m^3
  
  #fractionation factors:
  R = 8.314, #J/mol-K
  epsilon_d18O_eq = -7.685+6.7123*(1E3/temp.K)-1.6664*(1E6/temp.K^2)+0.35041*(1E9/temp.K^3),
  alpha_eq = exp(epsilon_d18O_eq/1000),
  alpha_kin = .975, 
  epsilon_kin = -25, #permil
  
  #isotope boundary conditions: 
  d18O_res = -4, #permil
  d180_surface = 0, #permil
  d18O_a = -14, #permil
  
  #Soil boundary conditions
  E = 10E-9, #m/sec
  p = 0.3, # porosity, unitless
  tau = 0.67, #toruosity, unitless
  theta = ifelse(z<=0.05, 0.05, (z+0.9)/19), #changes through the profile 
  N_sat = 0.017, #kg/m^2
  D = 1.5E-9, #m^2 / sec from Barnes and Allison, 1988
  D_v = 2.42E-5,
  f = tau*theta,
  D_star = f*D,  #m^2 / sec
  
  #liquid diffusion length scale 
  z_l = D_star/E, #m
  
  #relative humidity: 
  h_a = 0.2, 
  
  # water concentration: 
  theta_bar = 0.065,
  theta_0 = 0.05,
  
  #calculated terms
  eta = (1-h_a)/epsilon_kin,
  z_bar = (N_sat*D_v)/(rho*E),
  
  a = 0.05, #m
  diffusion_term  = (eta*(1+d18O_res)) + (d18O_res - d18O_a),
  humidity_term = (z/ (z+h_a*z_bar)),
  d18O =  (d18O_a + epsilon_d18O_eq + diffusion_term*humidity_term)/alpha_eq
  
)



vt_region %>% ggplot () + aes (x = d18O, y = z) + geom_line() + scale_y_reverse()

```


## liquid transport zone: 

$$
\delta = \delta_{reservoir} + (\delta_{ef} - \delta_{reservoir})exp({- \int_{zef}^z)\frac{dz}{z_1 +z_v}}\\
z_l = D^*/E \\
z_v = \frac{\alpha_{eq}*\alpha_{kin}*D^*N_{sat}}{E\rho}  \\ 

$$

```{r}
lt_region <- tibble (
  z = seq (0, 1, by=0.001),
  temp = 20, #°C
  temp.K = temp + 273.15,
  rho = 997, #kg/m^3
  
  #fractionation factors:
  R = 8.314, #J/mol-K
  epsilon_d18O_eq = -7.685+6.7123*(1E3/temp.K)-1.6664*(1E6/temp.K^2)+0.35041*(1E9/temp.K^3),
  alpha_eq = exp(epsilon_d18O_eq/1000),
  alpha_kin = 0.975, 
  epsilon_kin = -25, #permil
  
  #isotope boundary conditions: 
  d18O_res = -4, #permil
  d180_surface = 0, #permil
  d18O_a = -14, #permil

  #Soil boundary conditions
  E = 10E-10, #m/sec
  p = 0.3, # porosity, unitless
  tau = 0.67, #toruosity, unitless
  theta = ifelse(z<=0.05, 0.05, (z+0.9)/19), #changes through the profile
  N_sat = 0.017, #kg/m^2
  D = 1.5E-9, #m^2 / sec from Barnes and Allison, 1988
  D_v = 2.42E-5,
  f = tau*theta,
  D_star = f*D,  #m^2 / sec
  
  #length scales
  z_l = D_star/E, #m
  z_v = (alpha_eq*alpha_kin*D_star*N_sat)/(E*rho)
  
  
  #d18O_ltr <- d18O_res + ()
)
  

lt_region %>% ggplot() + aes (x=theta, y = z) + geom_line () + scale_y_reverse()
```



```{r}
z <- seq(0, 1, by = 0.001)
theta <- ifelse(z<=0.05, 0.05, (z+0.9)/19)
```


# Non- Isotothermal à la Allison and Barnes 1988 

so, lets add a more realistic temperature profile: 

  t_ave = 20,
  t_surface = 40
  kappa = 1E-6, # m^2/second, averge value for a loamy soil
  period = 60*60*24*365, #seconds in a year
  z_star  = sqrt((kappa*period)/pi),
  temp = t_ave + (t_surface - t_ave)*exp(-z/z_star)










The isotopic ratio at the top of the saturated surface can be calculated if you know the relative humidity of the atmosphere, the diffusion ratio, the isotopic ratio that is the source, and the isotope composition of the atmosphere
$$
R_{surface}  = \frac{(1-h_a)\sigma R_{res} +h_aR_a)} {\alpha_{eq}} \\
\text{where:}\\
h_a = \text{relative humidity of the atmosphere}\\
\sigma = \text{diffusion ratio} = 1+ (\epsilon_{kinetic}/(1-h_a))  \\
\eta_i = \text{diffusion ratio excess}\\

$$









